<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOUDA+ æŠ½å¥–ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-6 relative">

  <!-- åœ£è¯å…ƒç´  -->
  <img src="https://cdn.pixabay.com/photo/2017/12/29/22/28/santa-claus-3046642_1280.png" 
       alt="Santa" class="absolute top-5 right-5 w-16 h-16"/>

  <div class="max-w-md w-full bg-white shadow-md rounded-xl p-6 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">HOUDA+ æŠ½å¥–ç³»ç»Ÿ</h1>
    <p class="text-gray-600 mb-6">å¥–å“ï¼š1989åŸç‰ˆ CD ğŸµ <br>ä¸­å¥–æ¦‚ç‡ 2%</p>

    <button id="drawButton" 
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
      æŠ½å¥–
    </button>

    <div id="result" class="mt-6 text-lg text-gray-800 min-h-[40px]"></div>
  </div>

<script>
const drawButton = document.getElementById('drawButton');
const resultDiv = document.getElementById('result');

let isDrawing = false;
const owner = 'houda-hd';
const repo = 'houda-hd.github.io';

// è·å–æŠ½å¥–çŠ¶æ€
async function checkStatus() {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/status.json`);
    if (!res.ok) throw new Error("æ— æ³•è·å–çŠ¶æ€");
    const json = await res.json();
    if (json.hasWon) {
      drawButton.disabled = true;
      resultDiv.textContent = "æŠ½å¥–å·²ç»“æŸï¼Œå¥–å“å·²è¢«æŠ½å‡º âŒ";
      return true;
    } else {
      drawButton.disabled = false;
      return false;
    }
  } catch (err) {
    console.error(err);
    resultDiv.textContent = "åŠ è½½çŠ¶æ€å‡ºé”™ âš ï¸";
    return false;
  }
}

// æŠ½å¥–é€»è¾‘ï¼ˆå‰ç«¯åªæ˜¾ç¤ºæ•ˆæœï¼‰
async function drawLottery() {
  isDrawing = true;
  drawButton.disabled = true;
  resultDiv.textContent = "æ­£åœ¨æŠ½å¥–ï¼Œè¯·ç¨å€™...";

  try {
    const alreadyWon = await checkStatus();
    if (alreadyWon) {
      isDrawing = false;
      return;
    }

    // å‰ç«¯æ¨¡æ‹Ÿ 2% æ¦‚ç‡æ˜¾ç¤ºæ•ˆæœ
    const chance = Math.random() * 100;
    if (chance <= 2) {
      resultDiv.innerHTML = "ğŸ‰ æ­å–œï¼ä½ å¯èƒ½ä¸­å¥–äº†ï¼æ­£åœ¨æäº¤åå°åˆ¤å®š...";

      // è§¦å‘ GitHub Actions workflowï¼ˆæ— éœ€ PATï¼Œå‰ç«¯å¯æ”¹æˆè°ƒç”¨ä½ è‡ªå·±çš„ä¸­è½¬æ¥å£è§¦å‘ï¼‰
      await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github.v3+json',
          'Authorization': 'token YOUR_TRIGGER_PAT'  // ä»…è§¦å‘ workflow
        },
        body: JSON.stringify({ event_type: 'lottery-trigger' })
      });

      resultDiv.innerHTML = "ğŸ‰ æŠ½å¥–è¯·æ±‚å·²æäº¤ï¼Œåå°åˆ¤å®šç»“æœå°†æ›´æ–°çŠ¶æ€";

    } else {
      resultDiv.textContent = "å¾ˆé—æ†¾ï¼Œæœªä¸­å¥– ğŸ˜¢";
      drawButton.disabled = false;
    }
  } catch (err) {
    console.error(err);
    resultDiv.textContent = "æŠ½å¥–å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å° âš ï¸";
    drawButton.disabled = false;
  } finally {
    isDrawing = false;
  }
}

drawButton.addEventListener('click', drawLottery);

// è‡ªåŠ¨è½®è¯¢çŠ¶æ€
checkStatus();
setInterval(() => {
  if (!isDrawing) checkStatus();
}, 5000);
</script>
</body>
</html>
