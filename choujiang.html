<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOUDA+ æŠ½å¥–ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-6 relative">

  <!-- åœ£è¯å…ƒç´  -->
  <img src="https://cdn.pixabay.com/photo/2017/12/29/22/28/santa-claus-3046642_1280.png" 
       alt="Santa" class="absolute top-5 right-5 w-16 h-16"/>

  <div class="max-w-md w-full bg-white shadow-md rounded-xl p-6 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">HOUDA+ æŠ½å¥–ç³»ç»Ÿ</h1>
    <p class="text-gray-600 mb-6">å¥–å“ï¼š1989åŸç‰ˆ CD ğŸµ <br>ä¸­å¥–æ¦‚ç‡ 2%</p>

    <button id="drawButton" 
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
      æŠ½å¥–
    </button>

    <div id="result" class="mt-6 text-lg text-gray-800 min-h-[40px]"></div>
  </div>

<script>
  const owner = 'houda-hd';          
  const repo = 'houda-hd.github.io'; 
  const path = 'status.json';         
  const token = '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'; // æ›¿æ¢ä¸ºä½ çš„PAT

  const drawButton = document.getElementById('drawButton');
  const resultDiv = document.getElementById('result');

  let isDrawing = false; // æ§åˆ¶æŠ½å¥–è¿‡ç¨‹

  // è·å–æœ€æ–°çŠ¶æ€å’ŒSHA
  async function getLotteryStatus() {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if (!res.ok) {
      const errorData = await res.json();
      console.error("è·å–çŠ¶æ€å¤±è´¥ï¼š", errorData);
      throw new Error(`è·å–çŠ¶æ€å¤±è´¥ï¼š${res.status} ${res.statusText}`);
    }
    const data = await res.json();
    const content = atob(data.content);
    const json = JSON.parse(content);
    return { hasWon: json.hasWon, sha: data.sha };
  }

  // æ›´æ–°çŠ¶æ€
  async function updateLotteryStatus(sha) {
    const body = {
      message: "Update lottery status",
      content: btoa(JSON.stringify({ hasWon: true })),
      sha: sha
    };
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const errorData = await res.json();
      console.error("æ›´æ–°çŠ¶æ€å¤±è´¥ï¼š", errorData);
      throw new Error("æ›´æ–°çŠ¶æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥PATå’Œæ–‡ä»¶è·¯å¾„");
    }

    const data = await res.json();
    console.log("æ›´æ–°æˆåŠŸï¼Œæ–°çš„SHAï¼š", data.content.sha);
  }

  // æŠ½å¥–é€»è¾‘
  async function drawLottery() {
    isDrawing = true;
    drawButton.disabled = true;
    resultDiv.textContent = "æ­£åœ¨æŠ½å¥–ï¼Œè¯·ç¨å€™...";

    try {
      const { hasWon, sha } = await getLotteryStatus();

      if (hasWon) {
        resultDiv.textContent = "æŠ½å¥–å·²ç»“æŸï¼Œå¥–å“å·²è¢«æŠ½å‡º âŒ";
        isDrawing = false;
        return;
      }

      const randomChance = Math.random() * 100;
      if (randomChance <= 2) {
        resultDiv.innerHTML = "ğŸ‰ æ­å–œï¼ä½ èµ¢å¾—äº†å¥–å“ï¼š1989åŸç‰ˆ CD ğŸ";
        await updateLotteryStatus(sha);
      } else {
        resultDiv.textContent = "å¾ˆé—æ†¾ï¼Œæœªä¸­å¥– ğŸ˜¢";
        drawButton.disabled = false;
      }

    } catch (err) {
      console.error(err);
      resultDiv.textContent = "æŠ½å¥–å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å° âš ï¸";
      drawButton.disabled = false;
    } finally {
      isDrawing = false;
    }
  }

  drawButton.addEventListener('click', drawLottery);

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
  async function checkStatus() {
    try {
      const { hasWon } = await getLotteryStatus();
      if (hasWon) {
        drawButton.disabled = true;
        resultDiv.textContent = "æŠ½å¥–å·²ç»“æŸï¼Œå¥–å“å·²è¢«æŠ½å‡º âŒ";
      }
    } catch (err) {
      console.error(err);
      resultDiv.textContent = "åŠ è½½çŠ¶æ€å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢ âš ï¸";
    }
  }

  // åˆå§‹åŒ–
  checkStatus();

  // è‡ªåŠ¨è½®è¯¢ï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€ï¼ˆå¤šäººå…±äº«ï¼‰
  setInterval(() => {
    if (!isDrawing) checkStatus();
  }, 5000);

</script>
</body>
</html>