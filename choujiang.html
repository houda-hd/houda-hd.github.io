<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOUDA+ 抽奖系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-6 relative">

  <!-- 圣诞元素 -->
  <img src="https://cdn.pixabay.com/photo/2017/12/29/22/28/santa-claus-3046642_1280.png" 
       alt="Santa" class="absolute top-5 right-5 w-16 h-16"/>

  <div class="max-w-md w-full bg-white shadow-md rounded-xl p-6 text-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">HOUDA+ 抽奖系统</h1>
    <p class="text-gray-600 mb-6">奖品：1989原版 CD 🎵 <br>中奖概率 2%</p>

    <button id="drawButton" 
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
      抽奖
    </button>

    <div id="result" class="mt-6 text-lg text-gray-800 min-h-[40px]"></div>
  </div>

<script>
const drawButton = document.getElementById('drawButton');
const resultDiv = document.getElementById('result');

let isDrawing = false;
const owner = 'houda-hd';
const repo = 'houda-hd.github.io';

async function checkStatus() {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/status.json`);
    if (!res.ok) throw new Error("无法获取状态");
    const json = await res.json();
    if (json.hasWon) {
      drawButton.disabled = true;
      resultDiv.textContent = "抽奖已结束，奖品已被抽出 ❌";
    } else {
      drawButton.disabled = false;
    }
  } catch (err) {
    console.error(err);
    resultDiv.textContent = "加载状态出错 ⚠️";
  }
}

// 前端模拟抽奖点击，触发 workflow
async function drawLottery() {
  isDrawing = true;
  drawButton.disabled = true;
  resultDiv.textContent = "正在抽奖，请稍候...";

  try {
    await checkStatus();
    if (drawButton.disabled) {
      isDrawing = false;
      return;
    }

    resultDiv.textContent = "抽奖请求已发送，结果由后台 Actions 判定 🎁";

    // 触发 Actions workflow
    await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
      method: 'POST',
      headers: {
        'Accept': 'application/vnd.github.v3+json',
        'Authorization': 'token YOUR_TRIGGER_PAT' // 仅用于触发 workflow，不写入仓库
      },
      body: JSON.stringify({ event_type: 'lottery-trigger' })
    });

  } catch (err) {
    console.error(err);
    resultDiv.textContent = "抽奖出错，请检查控制台 ⚠️";
    drawButton.disabled = false;
  } finally {
    isDrawing = false;
  }
}

drawButton.addEventListener('click', drawLottery);

// 自动轮询状态
checkStatus();
setInterval(() => {
  if (!isDrawing) checkStatus();
}, 5000);

</script>
</body>
</html>
