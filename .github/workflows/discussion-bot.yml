name: ğŸ¤– Discussion Bot (with Summary)

on:
  discussion:
    types: [created, edited]
  discussion_comment:
    types: [created]

permissions:
  discussions: write
  contents: read

jobs:
  discussion-bot:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ¤– è‡ªåŠ¨æ¬¢è¿ä¸åˆ†ç±»
        uses: peter-evans/create-or-update-comment@v3
        if: github.event_name == 'discussion' && github.event.action == 'created'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.discussion.number }}
          body: |
            ğŸ‘‹ æ¬¢è¿æ¥åˆ° **HOUDA+ ç¤¾åŒºè®¨è®ºåŒº**ï¼

            æ„Ÿè°¢ä½ å‘èµ·æ–°è¯é¢˜ï½è¯·ç¡®ä¿ä½ çš„æ ‡é¢˜æ¸…æ™°ã€å†…å®¹è¯¦ç»†ã€‚
            - å¦‚æœæ˜¯æŠ¥å‘Š bugï¼Œè¯·é™„ä¸Šæˆªå›¾æˆ–é‡ç°æ­¥éª¤ ğŸ Â 
            - å¦‚æœæ˜¯åŠŸèƒ½å»ºè®®ï¼Œè¯·è¯´æ˜ä½¿ç”¨åœºæ™¯ ğŸ’¡ Â 
            - å¦‚æœåªæ˜¯é—²èŠï¼Œæ¬¢è¿å°½æƒ…å‘æŒ¥ ğŸ˜„ Â 

            æˆ‘æ˜¯è‡ªåŠ¨åŠ©æ‰‹ï¼Œä¼šå¸®å¿™ç»™è¯é¢˜åŠ ä¸Šåˆé€‚çš„æ ‡ç­¾å¹¶æç¤ºç®¡ç†å‘˜ã€‚

      - name: ğŸ· è‡ªåŠ¨æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          script: |
            const discussion = context.payload.discussion;
            const title = discussion.title.toLowerCase();

            let labels = [];

            if (title.includes('bug') || discussion.body.includes('é”™è¯¯')) {
              labels.push('ğŸ Bug');
            } else if (title.includes('å»ºè®®') || title.includes('feature')) {
              labels.push('ğŸ’¡ å»ºè®®');
            } else {
              labels.push('ğŸ’¬ ä¸€èˆ¬è®¨è®º');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: discussion.number,
                labels: labels
              });
            }

      - name: ğŸ’¬ å…³é”®è¯å›å¤
        uses: actions/github-script@v7
        if: github.event_name == 'discussion_comment'
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            const discussion_number = context.payload.discussion.number;

            let reply = null;

            if (comment.includes('/close')) {
              reply = "ğŸ›‘ å·²è¯·æ±‚å…³é—­æ­¤è®¨è®ºï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜ç¡®è®¤ã€‚";
            } else if (comment.includes('/thanks')) {
              reply = "ğŸ’– è°¢è°¢ä½ çš„åé¦ˆä¸æ”¯æŒï¼";
            } else if (comment.includes('bug')) {
              reply = "ğŸ å·²æ£€æµ‹åˆ°å…³é”®å­— **bug**ï¼Œæˆ‘ä»¬ä¼šå°½å¿«æŸ¥çœ‹ï¼";
            }

            if (reply) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: discussion_number,
                body: reply
              });
            }

      - name: ğŸ§  è‡ªåŠ¨æ€»ç»“æ´»è·ƒè®¨è®º
        if: github.event_name == 'discussion_comment'
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const discussion = context.payload.discussion;
            const discussion_number = discussion.number;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: discussion_number,
              per_page: 10,
            });

            // æŠŠæœ€è¿‘å‡ æ¡è¯„è®ºæ‹¼æˆç®€è¦æ–‡æœ¬
            const summaryInput = comments.data.map(c => `@${c.user.login}: ${c.body}`).join("\n");

            // è°ƒç”¨ OpenAI ç”Ÿæˆæ‘˜è¦ï¼ˆä½ éœ€è¦åœ¨ä»“åº“çš„ Secrets é‡Œæ·»åŠ  OPENAI_API_KEYï¼‰
            const fetch = require("node-fetch");
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                  { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªç®€æ´çš„ä¼šè®®è®°å½•åŠ©æ‰‹ï¼Œè¯·ç”¨ä¸€å¥ä¸­æ–‡æ€»ç»“è®¨è®ºæ ¸å¿ƒå†…å®¹ã€‚" },
                  { role: "user", content: summaryInput }
                ],
                max_tokens: 100,
              }),
            });

            const data = await response.json();
            const summary = data.choices?.[0]?.message?.content?.trim();

            if (summary) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: discussion_number,
                body: `ğŸ§¾ **è‡ªåŠ¨æ‘˜è¦ï¼š** ${summary}`,
              });
            }
